---
- name: install some core packages
  community.general.pacman:
    name:
    - alsa-utils
    - base-devel
    - brightnessctl
    - ctags
    - efibootmgr
    - gammastep
    - git
    - htop
    - jq
    - jre-openjdk
    - man
    - multipath-tools
    - noto-fonts
    - pacman-contrib
    - pacutils
    - pamixer
    - playerctl
    - pulseaudio
    - pulseaudio-alsa
    - pulseaudio-zeroconf
    - pulsemixer
    - ripgrep
    - spotifyd
    - sshfs
    - strace
    - sudo
    - usbutils
    - xdg-utils

- name: wheel sudoers rule
  ansible.builtin.lineinfile:
    path: /etc/sudoers
    regexp: '^%wheel ALL='
    line: '%wheel ALL=(ALL) NOPASSWD: ALL'
    validate: /usr/bin/visudo -cf %s

- name: enable en_US UTF8 locale
  community.general.locale_gen:
    name: en_US.UTF-8
    state: present

- name: set locale.conf
  ansible.builtin.copy:
    content: 'LANG=en_US.UTF-8'
    dest: /etc/locale.conf

- name: set timezone
  ansible.builtin.file:
    src: /usr/share/zoneinfo/Europe/Berlin
    dest: /etc/localtime
    state: link

- name: blacklist watchdog kernel module
  ansible.builtin.copy:
    content: 'blacklist sp5100_tco'
    dest: /etc/modprobe.d/sp5100_tco.conf

- name: quieten rtkit-daemon logging
  ansible.builtin.copy:
    src: quiet-rtkit-daemon-logging.conf
    dest: /etc/systemd/system/rtkit-daemon.service.d/

- name: disable systemd-homed PAM modules
  ansible.builtin.replace:
    path: /etc/pam.d/system-auth
    regexp: '^(?!#)(.*pam_systemd_home.so)'
    replace: '#\1'

- name: quieten pam_unix logging
  ansible.builtin.lineinfile:
    path: /etc/pam.d/system-auth
    regexp: '^(session.*pam_unix\.so)$'
    backrefs: yes
    line: '\1 quiet'

- name: setup /var/log/sudo.log
  ansible.builtin.lineinfile:
    path: /etc/sudoers
    line: 'Defaults logfile=/var/log/sudo.log'
    validate: /usr/bin/visudo -cf %s

- name: remove "good" sudo events from syslog
  ansible.builtin.lineinfile:
    path: /etc/sudoers
    line: 'Defaults syslog_goodpri=none'
    validate: /usr/bin/visudo -cf %s
